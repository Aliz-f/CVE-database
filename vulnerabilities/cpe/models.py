from termios import VT1
from django.db import models

# Create your models here.

class cveVulnerability(models.Model):
    cveId = models.CharField(verbose_name='cve id', max_length=100)
    dataType = models.CharField(verbose_name='cve data_type', max_length=50, null=True, blank=True)
    dataFormat = models.CharField(verbose_name='cve data_format', max_length=50, null=True, blank=True)
    dataVersion = models.CharField(verbose_name='cve data_version', max_length=50, null=True, blank=True)
    assigner = models.CharField(verbose_name='CVE_data_meta assigner', max_length=255,  null=True, blank=True)
    problemtype = models.JSONField(verbose_name='problemtype', null=True, blank=True)
    references = models.JSONField(verbose_name='references', null=True, blank=True)
    description = models.JSONField(verbose_name='description', null=True, blank=True)
    configurations = models.JSONField(verbose_name='configurations', null=True, blank=True)
    baseMetricV3 = models.JSONField(verbose_name='impact baseMetricV3', null=True, blank=True)
    baseMetricV2 = models.JSONField(verbose_name='impact baseMetricV2', null=True, blank=True)
    publishedDate = models.DateTimeField(verbose_name='publishedDate', null=True, blank=True)
    lastModifiedDate = models.DateTimeField(verbose_name='lastModifiedDate', null=True, blank=True)
    cwe = models.JSONField(verbose_name='cwe', null=True, blank=True)
    url = models.URLField(verbose_name='url', null=True, blank=True)
    v3score = models.FloatField(verbose_name='v3score', null=True, blank=True)
    
    v3severityList = (("LOW","LOW"),("MEDIUM","MEDIUM"),("HIGH","HIGH"),("CRITICAL","CRITICAL"),("NONE","NONE"))
    v3severity = models.CharField(verbose_name='v3severity', max_length=50,choices=v3severityList, default="NONE")
    
    v3exploitability = models.FloatField(verbose_name='v3exploitability', null=True, blank=True)
    v3impactScore = models.FloatField(verbose_name='v3impactScore', null=True, blank=True)
    v2score = models.FloatField(verbose_name='v2score', null=True, blank=True)
    
    v2severityList = (("LOW","LOW"),("MEDIUM","MEDIUM"),("HIGH","HIGH"),("NONE","NONE"))
    v2severity = models.CharField(verbose_name='v2severity', max_length=50, choices=v2severityList, default="NONE", null=True, blank=True)
    
    v2exploitability = models.FloatField(verbose_name='v2exploitability', null=True, blank=True)
    v2impactScore = models.FloatField(verbose_name='v2impactScore', null=True, blank=True)
    score = models.JSONField(verbose_name='score', null=True, blank=True)

    def __str__(self):
        return self.cveId

class product(models.Model):
    name = models.CharField(verbose_name = 'name', max_length=255)
    vendor = models.CharField(verbose_name = 'Vendor Company', max_length=255)
    cpes = models.ManyToManyField('cpeVulnerability', through='productCpeShip', blank=True, related_name='productCPEs', null=True)

    def __str__(self):
        return f'{self.vendor}:{self.name}'

class cpeVulnerability(models.Model):
    name = models.CharField(verbose_name = 'name', max_length=255)
    title = models.CharField(verbose_name = 'title', max_length=255, null=True, blank=True)
    deprecated = models.BooleanField(verbose_name = 'deprecated', default=False, null=True, blank=True)
    cpe23Uri = models.CharField(verbose_name = 'cpe23Uri', max_length=400, null=True, blank=True)
    lastModifiedDate = models.DateField(verbose_name = 'lastModifiedDate', null=True, blank=True)
    titles = models.JSONField(verbose_name = 'titles', null=True, blank=True)
    cves = models.ManyToManyField('cveVulnerability', through='cveAndCpeShip', related_name='cveforcpe', null=True, blank=True)
    cpeVersion = models.FloatField(verbose_name = 'cpeVersion', null=True, blank=True)
    versionPart1 = models.CharField(verbose_name = 'versionPart1', max_length=100, null=True, blank=True)
    versionPart2 = models.CharField(verbose_name = 'versionPart2', max_length=100, null=True, blank=True)
    versionPart3 = models.CharField(verbose_name = 'versionPart3', max_length=100, null=True, blank=True)
    versionPart4 = models.CharField(verbose_name = 'versionPart4', max_length=100, null=True, blank=True)
    versionPart5 = models.CharField(verbose_name = 'versionPart5', max_length=100, null=True, blank=True)
    versionPart6 = models.CharField(verbose_name = 'versionPart6', max_length=100, null=True, blank=True)
    versionPart7 = models.CharField(verbose_name = 'versionPart7', max_length=100, null=True, blank=True)

    def __str__(self):
        return self.name

class productCpeShip(models.Model):
    whichProduct = models.ForeignKey('product', on_delete=models.CASCADE, verbose_name = 'product')
    whichCpe = models.ForeignKey('cpeVulnerability', on_delete=models.CASCADE, verbose_name = 'cpe')

    def __str__(self):
        return f"{self.whichProduct.vendor}:{self.whichProduct.name}:{self.whichCpe.name}"

class cveAndCpeShip(models.Model):
    whichCve = models.ForeignKey('cveVulnerability',  on_delete=models.CASCADE, verbose_name = 'cve')
    whichCpe = models.ForeignKey('cpeVulnerability',  on_delete=models.CASCADE, verbose_name = 'cpe')

    def __str__(self):
        return f"{self.whichCpe.name} - {self.whichCve.cveId}"