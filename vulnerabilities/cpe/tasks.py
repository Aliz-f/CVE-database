from .models import *
from .utils import *
from .serializers import *
from .utils import *

from celery import shared_task
import time
import logging
import os, sys


@shared_task(max_retries=5, name='updateCve', queue='normal')
def updateCVe():
    '''
        for all cve, check lastModifiedDate, if change, cve get update
        you can change task time in admin panel
    '''
    try:
        iter_ok = 0
        iter_error = 0
        logging.info('Updating cve start')
        cveQuery = cveVulnerability.objects.all()
        for eachCve in cveQuery:
            cve = nvdDb.updateCve(eachCve.cveId)
            if eachCve.lastModifiedDate!=cve.get('lastModifiedDate'):
                cveSer = cveVulnerabilitySerializer(eachCve, cve)
                if cveSer.is_valid():
                    cveSer.save()
                    iter_ok+=1
                    logging.info(f'update {eachCve.cveId}')
                else:
                    iter_error +=1
                    logging.info(f'ERROR!! {eachCve.cveId} not updated')
            else:
                    logging.info(f'{eachCve.cveId} no need update')

        logging.info(f"{iter_ok} cve updated and {iter_error} cve not updated")
    except Exception as e:
        logging.info(str(e))


@shared_task(max_retries=5, name='updateCpe', queue='normal')
def updateCpe():
    '''
        check all product for new cpe and saved with all of cves.
        for cpes that exists, check lastModifiedDate for change. if change:
            1- update cpe
            2- check cves for update
        for cpes that exists, check lastModifiedDate for change. if not change:
            1- check for new cve 
    
    you can change task time in admin panel

    '''
    try:
        logging.info('Updating cpe start')
        cpeIter = 0
        cveIter=0
        productQuery = product.objects.all()
        for eachProduct in productQuery:
            nvd = nvdDb(eachProduct.vendor, eachProduct.name, eachProduct.type)
            for eachCpe in nvd.cpes:
                cpeQuery = cpeVulnerability.objects.filter(name=eachCpe.get('name'))
                if cpeQuery.exists():
                    if cpeQuery[0].lastModifiedDate != eachCpe.get('lastModifiedDate'):
                        cpeSer = cpeVulnerabilitySerializer(cpeQuery[0], eachCpe)
                        if cpeSer.is_valid():
                            cpeSaved=cpeSer.save()
                            logging.info(f"{cpeQuery[0].name} updated")
                            cpeIter+=1
                            nvd.searchCVE(cpeSaved.name)
                            for eachVuln in nvd.cves[cpeSaved.name]:
                                cveQuery = cveVulnerability.objects.filter(cveId=eachVuln["cveId"]) 
                                if not cveQuery.exists():
                                    cveSerializer = cveVulnerabilitySerializer(data=eachVuln)
                                    if cveSerializer.is_valid():
                                        cveSaved = cveSerializer.save()
                                        cveAndCpeShip.objects.create(whichCpe=cpeSaved, whichCve=cveSaved )
                                        cveIter+=1
                                        logging.info(f"{cveSaved.cveId} saved")
                                    else:
                                        id = eachVuln["cveId"]
                                        logging.info(f"ERROR!! {id} not saved")
                                elif cveQuery.exists() and not cveAndCpeShip.objects.filter(whichCpe=cpeSaved, whichCve=cveQuery).exists:
                                    cveAndCpeShip.objects.create(whichCpe=cpeSaved, whichCve=cveQuery[0] )
                                    logging.info(f"{cveQuery[0].cveId} ship saved")
                                else:
                                    pass
                        else:
                            logging.info(f"ERROR!! {cpeQuery[0].name} not updated")
                    else:
                        nvd.searchCVE(cpeQuery[0].name)
                        for eachVuln in nvd.cves[cpeQuery[0].name]:
                            cveQuery = cveVulnerability.objects.filter(cveId=eachVuln["cveId"]) 
                            if not cveQuery.exists():
                                cveSerializer = cveVulnerabilitySerializer(data=eachVuln)
                                if cveSerializer.is_valid():
                                    cveSaved = cveSerializer.save()
                                    cveAndCpeShip.objects.create(whichCpe=cpeQuery[0], whichCve=cveSaved )
                                    cveIter+=1
                                    logging.info(f"{cveSaved.cveId} saved")
                                else:
                                    id = eachVuln["cveId"]
                                    logging.info(f"ERROR!! {id} not saved")
                            elif cveQuery.exists() and not cveAndCpeShip.objects.filter(whichCpe=cpeQuery[0], whichCve=cveQuery).exists:
                                cveAndCpeShip.objects.create(whichCpe=cpeQuery[0], whichCve=cveSaved )
                                logging.info(f"{cveQuery.cveId} ship saved")
                            else:
                                logging.info(f"{cpeQuery[0].name} for {cveQuery[0].cveId} no need update")
                else:
                    cpeSerializer = cpeVulnerabilitySerializer(data=eachCpe)
                    if cpeSerializer.is_valid():
                        cpeSaved = cpeSerializer.save()
                        cpeIter+=1
                        logging.info(f"{cpeSaved.name} saved")
                        productCpeShip.objects.create(whichProduct =eachProduct, whichCpe = cpeSaved)
                        nvd.searchCVE(cpeSaved.name)
                        for eachVuln in nvd.cves[cpeSaved.name]:
                            cveQuery = cveVulnerability.objects.filter(cveId=eachVuln["cveId"]) 
                            if cveQuery.exists():
                                cveAndCpeShip.objects.create(whichCpe=cpeSaved, whichCve=cveQuery[0])
                                logging.info(f"{cpeSaved.title}:{cveQuery[0].cveId} saved")
                            else:
                                cveSerializer = cveVulnerabilitySerializer(data=eachVuln)
                                if cveSerializer.is_valid():
                                    cveSaved = cveSerializer.save()
                                    cveAndCpeShip.objects.create(whichCpe=cpeSaved, whichCve=cveSaved )
                                    cveIter+=1
                                    logging.info(f"{cveSaved.cveId} saved")
                                else:
                                    id = eachVuln["cveId"]
                                    logging.info(f"ERROR!! {id} not saved")
                    else:
                        name = eachCpe.get('name')
                        logging.info(f"ERROR!! {name} not saved")
        logging.info(f"{cpeIter} cpe saved and {cveIter} cve saved")
    except Exception as e:
        exc_type, exc_obj, exc_tb = sys.exc_info()
        fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
        logging.info(exc_type, fname, exc_tb.tb_lineno)


@shared_task( max_retries=5, name='updateProduct', queue='normal')
def updateProduct():
    '''
    read productList in /cpe/files/productList.csv, 
    for new product in productList, save all cpe and cves.
    you can change task time in admin panel
    '''
    try:
        productIter =0
        cpeIter = 0
        cpe_CveShipIter = 0
        cveIter=0
        os_path = os.getcwd()+'/cpe/files/productList.csv'
        productList=readFile(os_path)
        for eachProduct in productList:
            productQuery = product.objects.filter(name=eachProduct.get('name'), vendor=eachProduct.get('vendor'))
            if not productQuery.exists():
                productSer = productSerializer(data=eachProduct)
                if productSer.is_valid():
                    productSaved = productSer.save()
                    productIter+=1
                    logging.info(f"{productSaved.vendor}:{productSaved.name} saved")
                    nvd = nvdDb(productSaved.vendor, productSaved.name, productSaved.type)
                    for eachCpe in nvd.cpes:
                        cpeSerializer = cpeVulnerabilitySerializer(data=eachCpe)
                        if cpeSerializer.is_valid():
                            cpeSaved = cpeSerializer.save()
                            cpeIter+=1
                            logging.info(f"{cpeSaved.name} saved")
                            productCpeShip.objects.create(whichProduct =productSaved, whichCpe = cpeSaved)
                            nvd.searchCVE(cpeSaved.name)
                            for eachVuln in nvd.cves[cpeSaved.name]:
                                cveQuery = cveVulnerability.objects.filter(cveId=eachVuln["cveId"]) 
                                if cveQuery.exists():
                                    cveAndCpeShip.objects.create(whichCpe=cpeSaved, whichCve=cveQuery[0])
                                    cpe_CveShipIter+=1
                                    logging.info(f"{cpeSaved.title}:{cveQuery[0].cveId} saved")
                                else:
                                    cveSerializer = cveVulnerabilitySerializer(data=eachVuln)
                                    if cveSerializer.is_valid():
                                        cveSaved = cveSerializer.save()
                                        cveAndCpeShip.objects.create(whichCpe=cpeSaved, whichCve=cveSaved )
                                        cveIter+=1
                                        logging.info(f"{cveSaved.cveId} saved")
                                    else:
                                        cveId = eachVuln.get('cveId')
                                        logging.info(f"ERROR!! {cveId} not saved")
                        else:
                            cpeTitle= eachCpe.get('title')
                            logging.info(f"ERROR!! {cpeTitle} not saved")
                else:
                    vendorName = eachProduct.get('vendor')
                    productName = eachProduct.get('product')
                    logging.info(f"ERROR!! {vendorName}:{productName} not saved")
            else:
                logging.info(f"{productQuery[0].vendor}:{productQuery[0].name} exists in db")
        logging.info(f"{productIter} product, {cpeIter} cpe, {cveIter} cve and {cpe_CveShipIter} cve-cpe ship saved.")
    except Exception as e:
        logging.info(str(e))